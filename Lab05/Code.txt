;====================================================================
; Main.asm file generated by New Project wizard
;
; Created:   Вс ноя 14 2021
; Processor: PIC12F675
; Compiler:  MPASM (Proteus)
;====================================================================

;====================================================================
; DEFINITIONS
;====================================================================

#include p12f675.inc                ; Include register definition file
__CONFIG b'11111111010100'

;====================================================================
; CONSTANTS
;====================================================================

GPIO_DATA equ b'00101000' 
INTERRUPT_INIT equ b'11001000'
PIE1_INIT equ b'00000000'
TMR1H_INIT equ 0x0
TMR1L_INIT equ 0x0
TMR0_INIT equ 0x0
WPU_INIT equ b'010111'
IOC_INIT equ b'101000'
T1CON_INIT equ b'00000000'
;====================================================================
; VARIABLES
;====================================================================

sound_flags equ 20h
snd1_flag equ 00h
snd2_flag equ 01h
snd3_flag equ 02h

;LEDS_STATES equ 21h
;LED1 equ 00h
;LED2 equ 01h
;LED3 equ 02h

sound equ GP0

btn1 equ GP3
btn2 equ GP5

pc_states equ 21h
in_work_flag equ 00h
btn_wait_flag equ 01h
btn2_st equ 02h
btn3_st equ 03h

T1H_REG equ 22h
T1L_REG equ 23h

T02SecScaler equ 24h

;====================================================================
; RESET and INTERRUPT VECTORS
;====================================================================

      ; Reset Vector
RST   code  0x0 
      goto  START

INT code 0x4
	goto IINT_HNDL
	
	
;====================================================================
; CODE SEGMENT
;====================================================================

PGM   code

Init
	
	banksel ANSEL
    clrf ANSEL

    banksel CMCON
    movlw 0x7
    movwf CMCON

    banksel OPTION_REG
    movlw b'01001000'       ; Options
    movwf OPTION_REG

    banksel TRISIO
    movlw b'00101000'   ; GPIO Port options
    movwf TRISIO

    banksel GPIO
    movlw b'10' ; Default GPIO data
    movwf GPIO_DATA
    movwf GPIO

    banksel WPU
    movlw WPU_INIT  ; Pull ups
    movwf WPU

    banksel INTCON
    movlw INTERRUPT_INIT   ; Interrupts
    movwf INTCON

    banksel PIE1
    movlw PIE1_INIT  ; Enables timer 1 (16-bit) INTERRRUPT (NO)
    movwf PIE1

    banksel TMR1H
    movlw TMR1H_INIT
    movwf TMR1H
    movlw TMR1L_INIT
    movwf TMR1L

    banksel T1CON
    movlw T1CON_INIT    ; Enables timer 1
    movwf T1CON

    banksel IOC
    movlw IOC_INIT
    movwf IOC

    return
	
	
IINT_HNDL
	btfsc INTCON,  GPIF
	GOTO GPIO_INT
	btfsc INTCON, T0IF
	GOTO T0_INT
	banksel PIR1
	btfsc PIR1, TMR1IF
	GOTO T1_INT
	return
	
	
	
	
	
	
GPIO_INT 
	SB2_check
		banksel GPIO
		btfsc GPIO, GPIO3
		GOTO SB3_check
		
		; Обработка нажатия клавиши SB2  + проверка нажатия сразу второй
		btfsc GPIO, GPIO5
		GOTO ONLY_SB2
		; Если нажаты две кнопки
			movlw 1h
			andwf pc_states, f
			CALL Start_Mode3
			retfie
		
		ONLY_SB2
			; Запуск таймера на 1 мс в ожидании нажатия второй кнопки, после этого происходит обработка кнопок (ЕСЛИ НЕ ЗАПУЩЕН УЖЕ!!!!!!!!!!)
			btfsc pc_states, btn_wait_flag	; Проверка, что таймер уже запущен
			GOTO ONLY_set_bitSB2
			; Если не запущен таймер
			movlw b'01000010' 
			banksel OPTION_REG
			movwf OPTION_REG
			movlw 83h
			banksel TMR0
			movwf TMR0					; Тут стартовал таймер на 1 мс
			bsf INTCON, T0IE			; Тут разрешили преоывания
			bsf pc_states, btn_wait_flag
		ONLY_set_bitSB2	
			bsf pc_states, btn2_st			; Запись, что кнопка 2 нажата 
			;CALL Start_Mode1
			retfie

		
	SB3_check	
		banksel GPIO
		btfsc GPIO, GPIO5
		retfie
		
		; Обработка нажатия клавиши SB3 + проверка нажатия сразу первой
		btfsc GPIO, GPIO3
		GOTO ONLY_SB3
			; Если нажаты две кнопки
			movlw 1h
			andwf pc_states, f
			CALL Start_Mode3
			retfie
		
		ONLY_SB3
				; Запуск таймера на 1 мс в ожидании нажатия ПЕРВОЙ  кнопки, после этого происходит обработка кнопок (ЕСЛИ НЕ ЗАПУЩЕН УЖЕ!!!!!!!!!!)
			btfsc pc_states, btn_wait_flag		; Проверка, что таймер уже запущен
			GOTO ONLY_set_bitSB3
			; Если не запущен таймер
			movlw b'01000010' 
			banksel OPTION_REG
			movwf OPTION_REG
			movlw 83h
			banksel TMR0
			movwf TMR0					; Тут стартовал таймер на 1 мс
			bsf INTCON, T0IE			; Тут разрешили преоывания
			bsf pc_states, btn_wait_flag
		ONLY_set_bitSB3
			bsf pc_states, btn3_st			; Запись, что кнопка 2 нажата 
			;CALL Start_Mode2
			retfie
			
	
Start_Mode3
	; Запустить таймер для времени в 2 сек (Таймер 0)
	CALL Start2SecTmr
	; Запустить таймер 1 для отрабатывания звука с заданной частотой в 3 кГц
	movlw 0FCh
	movwf T1H_REG
	banksel TMR1H
	movwf TMR1H
	movlw 18h
	movwf T1L_REG
	movwf TMR1L
	banksel PIE1
	bsf PIE1, TMR1IE
	bsf INTCON, PEIE
	return
	
Start2SecTmr
	movlw b'01000110'
	banksel OPTION_REG
	movwf OPTION_REG
	movlw 7Dh
	movwf T02SecScaler
	bsf INTCON, T0IE			; Тут разрешили преоывания
	return
	
T0_INT
	bsf INTCON, GIE
	btfss pc_states, btn_wait_flag
	GOTO Check_on2sec
		; Если по истечению 1 мс для кнопок
		btfss pc_states, btn2_st
		GOTO Check_btn3
			; Если нажата 1 кнопка
			btfss pc_states, btn3_st		; Нажата ли вторая?
			GOTO Pressed_ONLY_btn2 ; Если нажата только одна
				; Если нажаты две кнопки
				movlw 1h
				andwf pc_states, f
				CALL Start_Mode3
				retfie
			Pressed_ONLY_btn2
				movlw 1h
				andwf pc_states, f
				CALL Start_Mode1
				retfie
		Check_btn3
			; Если нажата ТОЛЬКО 2 кнопка
			movlw 1h
			andwf pc_states, f
			CALL Start_Mode2
			retfie
			
	; Если вышло время в 2 сек	
	Check_on2sec		
		decfsz T02SecScaler, f
		GOTO ScalerNotZero
		GOTO ScalerISZero
			
		ScalerISZero
			banksel T1CON
			bcf INTCON, T0IE ; Выключаем прерывания Таймера 0
			;bcf PIE1, TMR0IE ; Выключаем прерывания Таймера 1
			bcf T1CON, TMR1ON  ; Выключаем Таймер 1
			retfie
			
		ScalerNotZero
			movlw 83h
			movwf TMR0
			bcf INTCON, T0IF
			bsf INTCON, T0IE
			retfie
		
T1_INT
	bsf INTCON, GIE
	banksel GPIO
	btfss GPIO, sound
	GOTO SET1_inSound
		; Если сейчас SOUND = 1
		bcf GPIO, sound
		GOTO T1_refull
	SET1_inSound ; Если сейчас SOUND = 0
		bsf GPIO, sound
		
	T1_refull
		movf T1H_REG, w
		movwf TMR1H
		movf T1L_REG, w
		movwf TMR1L
		retfie
		
Start_Mode1
	; Запустить таймер для времени в 2 сек (Таймер 0)
	CALL Start2SecTmr
	; Запустить таймер 1 для отрабатывания звука с заданной частотой в 3 кГц
	movlw 0FEh
	movwf T1H_REG
	banksel TMR1H
	movwf TMR1H
	movlw 0Ch
	movwf T1L_REG
	movwf TMR1L
	banksel PIE1
	bsf PIE1, TMR1IE
	bsf INTCON, PEIE
	return
	
	
Start_Mode2
; Запустить таймер для времени в 2 сек (Таймер 0)
	CALL Start2SecTmr
	; Запустить таймер 1 для отрабатывания звука с заданной частотой в 3 кГц
	movlw 0FEh
	movwf T1H_REG
	banksel TMR1H
	movwf TMR1H
	movlw 0Ch
	movwf T1L_REG
	movwf TMR1L
	banksel PIE1
	bsf PIE1, TMR1IE
	bsf INTCON, PEIE
	return

START
	Start_loop
	GOTO Start_loop
;====================================================================
      END
